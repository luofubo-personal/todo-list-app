name: Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  statuses: write
  security-events: write

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '22.x'

jobs:
  # Code quality checks
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better analysis
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: './frontend/angular-app/package-lock.json'
        
    - name: Install .NET tools
      run: |
        dotnet tool install --global dotnet-format
        dotnet tool install --global dotnet-reportgenerator-globaltool
        
    - name: Check .NET code formatting
      run: |
        dotnet format backend/TodoApi/TodoApi.csproj --verify-no-changes --verbosity diagnostic
        dotnet format backend/TodoApi.Tests/TodoApi.Tests.csproj --verify-no-changes --verbosity diagnostic
        
    - name: Install frontend dependencies
      working-directory: ./frontend/angular-app
      run: npm ci --legacy-peer-deps
      
    - name: Run Angular linting
      working-directory: ./frontend/angular-app
      run: npm run lint || echo "Linting issues found but continuing..."
      
    - name: Check TypeScript formatting
      working-directory: ./frontend/angular-app
      run: |
        npx prettier --check "src/**/*.{ts,html,css,scss,json}"
        
    - name: Run SonarCloud Scan
      if: ${{ secrets.SONAR_TOKEN != '' }}
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Comprehensive testing
  comprehensive-tests:
    name: Comprehensive Testing
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        dotnet-version: ['9.0.x']
        node-version: ['20.x', '22.x']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET ${{ matrix.dotnet-version }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
        
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: './frontend/angular-app/package-lock.json'
        
    - name: Restore .NET dependencies
      run: |
        dotnet restore backend/TodoApi/TodoApi.csproj
        dotnet restore backend/TodoApi.Tests/TodoApi.Tests.csproj
        
    - name: Build .NET projects
      run: |
        dotnet build backend/TodoApi/TodoApi.csproj --no-restore --configuration Release
        dotnet build backend/TodoApi.Tests/TodoApi.Tests.csproj --no-restore --configuration Release
        
    - name: Run .NET unit tests
      run: |
        dotnet test backend/TodoApi.Tests/TodoApi.Tests.csproj \
          --configuration Release \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --logger trx \
          --results-directory ./TestResults

    - name: List .NET test results (debug)
      if: always()
      run: |
        echo "Contents of TestResults directory:"
        ls -la ./TestResults/ || echo "TestResults directory not found"
        find . -name "*.trx" -type f || echo "No .trx files found"
          
    - name: Install Angular dependencies
      working-directory: ./frontend/angular-app
      run: npm ci --legacy-peer-deps
      
    - name: Run Angular tests
      working-directory: ./frontend/angular-app
      run: |
        npm run test -- \
          --watch=false \
          --browsers=ChromeHeadless \
          --code-coverage \
          --reporters=progress,junit
          
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-dotnet${{ matrix.dotnet-version }}-node${{ matrix.node-version }}
        path: |
          ./TestResults
          ./frontend/angular-app/coverage

  # Integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: './frontend/angular-app/package-lock.json'
        
    - name: Build backend for integration test
      run: |
        dotnet build backend/TodoApi/TodoApi.csproj --configuration Release

    - name: Start backend API (in-memory database)
      run: |
        cd backend/TodoApi
        dotnet run --urls="http://localhost:5001" &
        sleep 10
      env:
        ASPNETCORE_ENVIRONMENT: Development

    - name: Install frontend dependencies
      working-directory: ./frontend/angular-app
      run: npm ci --legacy-peer-deps

    - name: Build frontend
      working-directory: ./frontend/angular-app
      run: npm run build

    - name: Integration tests
      run: |
        echo "Running integration tests..."

        # Wait for API to be ready
        timeout 60 bash -c 'until curl -s http://localhost:5001/health > /dev/null; do sleep 2; echo "Waiting for API..."; done' || echo "API may not be ready"

        # Test backend health
        if curl -f http://localhost:5001/health; then
          echo "✅ Backend health check passed"
        else
          echo "⚠️ Backend health check failed"
        fi

        # Test API endpoints
        if curl -f http://localhost:5001/api/todos; then
          echo "✅ API endpoints accessible"
        else
          echo "⚠️ API endpoints not accessible"
        fi

        echo "✅ Integration tests completed"

    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up processes..."
        pkill -f "dotnet run" || echo "No backend processes to kill"

  # Performance tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'performance')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install NBomber
      run: dotnet tool install --global NBomber.CLI
      
    - name: Run performance tests
      run: |
        # Add your performance test commands here
        echo "Running performance tests..."
        # nbomber run --config performance-test-config.json
        
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results-${{ github.run_id }}
        path: ./performance-results

  # Security validation
  security-validation:
    name: Security Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Snyk security scan
      if: ${{ secrets.SNYK_TOKEN != '' }}
      uses: snyk/actions/dotnet@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
    - name: Run npm audit
      working-directory: ./frontend/angular-app
      run: |
        npm audit --audit-level=high
        
    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'todo-list-app'
        path: '.'
        format: 'ALL'
        
    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results-${{ github.run_id }}
        path: reports

  # PR summary
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [code-quality, comprehensive-tests, integration-tests, security-validation]
    if: always()
    
    steps:
    - name: Generate PR summary
      uses: actions/github-script@v7
      with:
        script: |
          const results = {
            'Code Quality': '${{ needs.code-quality.result }}',
            'Comprehensive Tests': '${{ needs.comprehensive-tests.result }}',
            'Integration Tests': '${{ needs.integration-tests.result }}',
            'Security Validation': '${{ needs.security-validation.result }}'
          };
          
          let summary = '## 🔍 PR Validation Summary\n\n';
          
          for (const [check, result] of Object.entries(results)) {
            const emoji = result === 'success' ? '✅' : result === 'failure' ? '❌' : '⏭️';
            summary += `${emoji} **${check}**: ${result}\n`;
          }
          
          summary += '\n---\n';
          summary += 'This PR has been automatically validated. ';
          
          const allPassed = Object.values(results).every(r => r === 'success' || r === 'skipped');
          if (allPassed) {
            summary += '🎉 All checks passed! Ready for review.';
          } else {
            summary += '⚠️ Some checks failed. Please review and fix issues.';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
